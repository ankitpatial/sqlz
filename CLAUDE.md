# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Test Commands

```sh
zig build                          # Build the executable (output: zig-out/bin/sqlz)
zig build -Doptimize=.ReleaseSafe  # Release build
zig build test                     # Run all unit tests (library + executable modules)
zig build run -- generate --src db/sql/ --dest db/query/  # Run with arguments
```

Tests are pure unit tests (no database required). Integration testing requires a running PostgreSQL instance with `DATABASE_URL` set.

## Architecture

sqlz is a CLI code generator inspired by [sqlc](https://sqlc.dev). It reads `.sql` files, introspects queries against a live PostgreSQL database, and generates type-safe Zig source code.

### Pipeline

```
SQL files → query.parseFile() → UntypedQuery[]
                                      ↓
                        introspect.describeQueries()  ← live PostgreSQL (Parse/Describe/Sync)
                                      ↓
                               TypedQuery[]
                                      ↓
                          codegen.generate()  → per-module .zig files
                          codegen.generateHelper()  → helper.zig (shared types: Timestamp, enums)
                          codegen.generateRoot()    → root.zig (re-exports all modules)
```

### Module Responsibilities

- **`main.zig`** — CLI entry point. Parses args, reads `DATABASE_URL` (env or `.env` file), orchestrates the pipeline. Contains `Config`, `parseDatabaseUrl`, `loadDotEnvValue`.
- **`root.zig`** — Library root, re-exports all public modules.
- **`query.zig`** — SQL file parser. Handles sqlc-style annotations (`-- name: QueryName :kind`), multi-query files, and fallback single-query parsing from filename.
- **`introspect.zig`** — Connects parsed queries to PostgreSQL via extended query protocol (Parse→Describe→Sync). Resolves parameter types, column types, nullability (via `pg_attribute`), and enum types (via `pg_enum`). Extracts parameter names from SQL context (column names, INSERT column lists).
- **`codegen.zig`** — Generates Zig source from `TypedQuery[]`. Emits row structs, params structs (when >3 params), and execution functions (`pool.row`, `pool.query`, `pool.exec`). Handles helper-relative imports for shared types.
- **`types.zig`** — `ZigType` tagged union mapping PostgreSQL OIDs to Zig types. Includes `TypeCache` and `NullabilityCache`.
- **`connection.zig`** — Raw TCP connection to PostgreSQL. Implements message send/receive using fixed 16KB buffers.
- **`protocol.zig`** — PostgreSQL wire protocol v3. Encodes frontend messages (Startup, Parse, Describe, Query, Sync, Terminate) and decodes backend messages (`BackendMsg` tagged union).
- **`auth.zig`** — Authentication handlers: cleartext, MD5, SCRAM-SHA-256.
- **`scram.zig`** — SCRAM-SHA-256 implementation (PBKDF2, client-first/final, server verification).
- **`project.zig`** — File discovery. Walks `--src` directory for `.sql` files, groups them into `SqlFileGroup` (one `.zig` output per `.sql` input).
- **`errors.zig`** — Structured error types with colored terminal output.

### Key Design Decisions

- **No external dependencies** — implements PostgreSQL wire protocol directly using Zig stdlib.
- **Params struct threshold** — queries with >3 parameters generate a named `Params` struct; otherwise parameters are positional function arguments (`codegen.zig:8`).
- **Nullability** — determined by: (1) column alias suffix `!` (not null) or `?` (nullable), (2) `pg_attribute.attnotnull` lookup, (3) defaults to nullable.
- **Alias hint quoting** — `!` and `?` suffixes in column aliases are auto-quoted so PostgreSQL accepts them (`introspect.zig:quoteAliasHints`).
- **Generated code marker** — all output files start with `// Code generated by sqlz. DO NOT EDIT.`
- **generate mode** cleans the `--dest` directory before writing to remove stale files.

### SQL Annotation Format

```sql
-- name: QueryName :kind
```

Kinds: `:one` (`?Row`), `:many` (`[]Row`), `:exec` (`void`), `:execrows` (`?usize`).

Files without annotations derive the query name from the filename and auto-detect the kind.
